# TODO
#   Find what command line arguments need to be given to a vim instance in
#   order to just run these tests.


#"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""#
#                                   Motion                                    #
#"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""#
Given vsh (vsh buffer):
  vimshell: >
  vimshell: >    #echo Hello there
  vimshell: >    echo Hello there

Do (Motion down skips comments and empty lines):
  \<C-n>ix

Expect:
  vimshell: >
  vimshell: >    #echo Hello there
  vimshell: >    xecho Hello there

Do (Motion down with no extra prompts stays at end):
  \<C-n>\<C-n>ix

Expect:
  vimshell: >
  vimshell: >    #echo Hello there
  vimshell: >    xecho Hello there

Do (Moving up at start of file does nothing):
  \<C-p>ix

Expect:
  xvimshell: >
  vimshell: >    #echo Hello there
  vimshell: >    echo Hello there


Do (Moving up with no previous prompt goes to top):
  \<C-n>\<C-p>ix

Expect:
  xvimshell: >
  vimshell: >    #echo Hello there
  vimshell: >    echo Hello there


Given vsh (vsh buffer):
  vimshell: > echo Hello there
  Hello there, this is output

Do (Moving down at last prompt moves to end of output):
  \<C-n>\<C-n>ix

Expect:
  vimshell: > echo Hello there
  xHello there, this is output

Do (Moving up on top prompt doesn't move cursor):
  \<C-n>\<C-p>ix

Expect:
  vimshell: > xecho Hello there
  Hello there, this is output

Given vsh (vsh buffer):
  vimshell: > # vimshell: > ls
  vimshell: > ls

Do (Down motion includes saved output):
  \<C-n>ix

Expect:
  vimshell: > # vimshell: > xls
  vimshell: > ls

Do (Up motion includes saved output):
  \<C-n>\<C-n>\<C-p>ix

Expect:
  vimshell: > # vimshell: > xls
  vimshell: > ls


Given vsh (vsh buffer):
  vimshell: > 
  vimshell: > ls

Do (Down motion includes complete prompts without commands):
  \<C-n>ix

Expect:
  vimshell: >x 
  vimshell: > ls

Do (Up motion includes complete prompts without commands):
  \<C-n>\<C-n>\<C-p>ix

Expect:
  vimshell: >x 
  vimshell: > ls


# Tabs count as a command character
Given vsh (vsh buffer):
  vimshell: > 	ls

Do (Don't skip tabs):
  \<C-n>ix

Expect:
  vimshell: > x	ls

# In Operator Pending mode we select *up to* the previous prompt
Given vsh (vsh buffer):
  vimshell: > ls
  many
  many
  files
  vimshell: > ls

Do (Up to top line):
  jjd\<C-p>

Expect:
  vimshell: > ls
  files
  vimshell: > ls

Do (Down to bottom line):
  jj$d\<C-n>

Expect:
  vimshell: > ls
  many
  vimshell: > ls

Do (Down before first line):
  d\<C-n>

Expect:
  many
  many
  files
  vimshell: > ls

Do (Down from first line):
  $d\<C-n>

Expect:
  vimshell: > ls

Do (Up from last line):
  2\<C-n>$d\<C-p>

Expect:
  vimshell: > ls

Given vsh (vsh buffer):
  Bunch
  of lines
  at start
  vimshell: > ls
  many
  many
  files

Do (Up nothing above):
  jd\<C-p>

Expect:
  at start
  vimshell: > ls
  many
  many
  files

Do (Down nothing below):
  \<C-n>jjd\<C-n>

Expect:
  Bunch
  of lines
  at start
  vimshell: > ls
  many

#"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""#
#                              Parsing Commands                               #
#"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""#
Given vsh (vsh buffer):
  vimshell: >
  vimshell: > 
  vimshell: > ls
  vimshell: >   ls
  vimshell: > 	ls
  vimshell: > # ls
  vimshell: > #ls
  vimshell: >   #ls
  vimshell: >  	#ls
  hello there


Do (Parsing Works nicely):
  :g/^/put =vsh#vsh#ParseVSHCommand(getline('.'))\<CR>

Expect:
  vimshell: >
  -1
  vimshell: > 
  -1
  vimshell: > ls
  ls
  vimshell: >   ls
    ls
  vimshell: > 	ls
  	ls
  vimshell: > # ls
  -1
  vimshell: > #ls
  -1
  vimshell: >   #ls
  -1
  vimshell: >  	#ls
   	#ls
  hello there
  -1


"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""
"                                Output Range                                 "
"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""
Given vsh (vsh buffer):
  vimshell: >
  vimshell: >

  vimshell: >




  vimshell: >


Do (OutputRange() works nicely):
  :g/vimshell/s/$/\=vsh#vsh#OutputRange()\<CR>

Expect:
  vimshell: >
  vimshell: >3,3

  vimshell: >5,8




  vimshell: >

Given vsh (vsh buffer):
  vimshell: >
  hello there

Do (OutputRange() Final line):
  :s/$/\=vsh#vsh#OutputRange()\<CR>

Expect:
  vimshell: >2,2
  hello there


Given vsh (vsh buffer):
  vimshell: >





  vimshell: >

Do (OutputRange() inside output):
  j:s/$/\=vsh#vsh#OutputRange()\<CR>

Expect:
  vimshell: >
  2,6




  vimshell: >

"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""
"                            Save Output function                             "
"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""

Given vsh (vsh buffer):
  vimshell: > ls
  bin            records    share     tentel_password.txt  TODO
  pstree_output  sensitive  temp_dir  test.vsh             xresources
  $ 
  vimshell: > echo Hello


Do (Save output on command line):
  \six

Expect:
  xvimshell: > # vimshell: > ls
  bin            records    share     tentel_password.txt  TODO
  pstree_output  sensitive  temp_dir  test.vsh             xresources
  $ 
  vimshell: > echo Hello

Do (Save output when in output):
  j\six

Expect:
  vimshell: > # vimshell: > ls
  xbin            records    share     tentel_password.txt  TODO
  pstree_output  sensitive  temp_dir  test.vsh             xresources
  $ 
  vimshell: > echo Hello


"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""
"                           Unsave output function                            "
"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""

Given vsh (vsh buffer):
  vimshell: > # vimshell: > ls
  bin            records    share     tentel_password.txt  TODO
  pstree_output  sensitive  temp_dir  test.vsh             xresources
  $ 
  vimshell: > echo Hello

Do (Unsave output on command line):
  \aix

Expect:
  xvimshell: > ls
  bin            records    share     tentel_password.txt  TODO
  pstree_output  sensitive  temp_dir  test.vsh             xresources
  $ 
  vimshell: > echo Hello

Do (Unsave output when in output):
  j\aix

Expect:
  vimshell: > ls
  xbin            records    share     tentel_password.txt  TODO
  pstree_output  sensitive  temp_dir  test.vsh             xresources
  $ 
  vimshell: > echo Hello

"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""
"                                 New Prompt                                  "
"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""


Given vsh (vsh buffer):
  vimshell: > ls
  bin            records    share     tentel_password.txt  TODO
  pstree_output  sensitive  temp_dir  test.vsh             xresources
  $ 
  vimshell: > echo Hello

Do (Unsave output on command line):
  \nx

Expect:
  vimshell: > ls
  bin            records    share     tentel_password.txt  TODO
  pstree_output  sensitive  temp_dir  test.vsh             xresources
  $ 
  vimshell: > x
  vimshell: > echo Hello

Do (Unsave output when in output):
  \<C-n>\<C-n>\nx

Expect:
  vimshell: > ls
  bin            records    share     tentel_password.txt  TODO
  pstree_output  sensitive  temp_dir  test.vsh             xresources
  $ 
  vimshell: > echo Hello
  vimshell: > x

"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""
"                               Select Command                                "
"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""

Given vsh (vsh buffer):
  vimshell: >
  vimshell: > 
  vimshell: >    #echo Hello there
  vimshell: > echo Hello there
  Hello there
  vimshell: >    echo Hello there

Do (Does nothing before empty prompt):
  cicx

Expect:
  xvimshell: >
  vimshell: > 
  vimshell: >    #echo Hello there
  vimshell: > echo Hello there
  Hello there
  vimshell: >    echo Hello there

Do (Works on empty prompts (Reasonably: not great)):
  jcicx

Expect:
  vimshell: >
  vimshell: >x
  vimshell: >    #echo Hello there
  vimshell: > echo Hello there
  Hello there
  vimshell: >    echo Hello there

Do (Ignores comment prompts):
  jjcicx

Expect:
  vimshell: >
  vimshell: >x
  vimshell: >    #echo Hello there
  vimshell: > echo Hello there
  Hello there
  vimshell: >    echo Hello there


# Real command
Do (Selects inner command on real command):
  jjjcicx

Expect:
  vimshell: >
  vimshell: > 
  vimshell: >    #echo Hello there
  vimshell: > x
  Hello there
  vimshell: >    echo Hello there


Do (Selects outer command on real command):
  jjjcacx

Expect:
  vimshell: >
  vimshell: > 
  vimshell: >    #echo Hello there
  vimshell: > x
  Hello there
  vimshell: >    echo Hello there


# Select command when in output
Do (Selects inner command when in output):
  jjjjcicx

Expect:
  vimshell: >
  vimshell: > 
  vimshell: >    #echo Hello there
  vimshell: > x
  Hello there
  vimshell: >    echo Hello there


Do (Selects outer command when in output):
  jjjjcacx

Expect:
  vimshell: >
  vimshell: > 
  vimshell: >    #echo Hello there
  vimshell: > x
  Hello there
  vimshell: >    echo Hello there


# Command with spaces
Do (Selects inner command excluding spaces):
  jjjjjcicx

Expect:
  vimshell: >
  vimshell: > 
  vimshell: >    #echo Hello there
  vimshell: > echo Hello there
  Hello there
  vimshell: >    x

Do (Selects outer command including spaces):
  jjjjjcacx

Expect:
  vimshell: >
  vimshell: > 
  vimshell: >    #echo Hello there
  vimshell: > echo Hello there
  Hello there
  vimshell: > x

Do (Works with the redo '.' command):
  jjjdacjj.

Expect:
  vimshell: >
  vimshell: > 
  vimshell: >    #echo Hello there
  vimshell: > 
  Hello there
  vimshell: > 


"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""
"                             Output Text object                              "
"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""

Given vsh (vsh buffer):
  vimshell: >
  vimshell: >
  One line output
  vimshell: >
  Multiple
  line
  output
  vimshell: >
  Output at the
  end of the buffer

Do (Change output when no output):
  ciox

Expect:
  xvimshell: >
  vimshell: >
  One line output
  vimshell: >
  Multiple
  line
  output
  vimshell: >
  Output at the
  end of the buffer

Do (Change OUTPUT when no output):
  caox

Expect:
  x
  vimshell: >
  One line output
  vimshell: >
  Multiple
  line
  output
  vimshell: >
  Output at the
  end of the buffer

Do (Change output when one line of output):
  jciox

Expect:
  vimshell: >
  vimshell: >
  x
  vimshell: >
  Multiple
  line
  output
  vimshell: >
  Output at the
  end of the buffer

Do (Change OUTPUT when one line of output):
  jcaox

Expect:
  vimshell: >
  x
  vimshell: >
  Multiple
  line
  output
  vimshell: >
  Output at the
  end of the buffer

Do (Change output when multiple lines):
  jjjciox

Expect:
  vimshell: >
  vimshell: >
  One line output
  vimshell: >
  x
  vimshell: >
  Output at the
  end of the buffer

Do (Change output when multiple lines):
  jjjcaox

Expect:
  vimshell: >
  vimshell: >
  One line output
  x
  vimshell: >
  Output at the
  end of the buffer


Do (Works with the redo '.' command):
  jjdioj.

Expect:
  vimshell: >
  vimshell: >
  vimshell: >
  vimshell: >
  Output at the
  end of the buffer

"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""
"                            Start Ranged Command                             "
"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""

Given vsh (vsh buffer):
  vimshell: > echo Hello there
  Hello there
  vimshell: > echo Hello there
  These are some lines
  Hello there

Do (Output range inserted properly):
  \od\<CR>

Expect:
  vimshell: > echo Hello there
  vimshell: > echo Hello there
  These are some lines
  Hello there

Do (Output range calculated well at end of file):
  jj\od\<CR>

Expect:
  vimshell: > echo Hello there
  Hello there
  vimshell: > echo Hello there

"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""
"                              BOL override keys                              "
"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""

# # The function that "I" calls uses " " feedkeys(), and that interferes with
# # Vader, hence don't use this.
Given vsh (vsh buffer):
  vimshell: > echo hello
  vimshell: >   echo hello
  vimshell: > # Not a command
  Also not a command

Do ('^' normal mode override):
  ^iw\<esc>j^ix\<esc>j^iy\<esc>j^iz

Expect:
  vimshell: > wecho hello
  vimshell: >   xecho hello
  yvimshell: > # Not a command
  zAlso not a command

Do ('^' operator pending mode override);
  $c^w\<esc>j$c^x\<esc>j$c^y\<esc>j$c^z

Expect:
  vimshell: > wo
  vimshell: >   xo
  yd
  zd

"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""
"                           Adds prompt on newline                            "
"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""

Given vsh (vsh buffer):
  vimshell: > echo Hello
  other: > echo Hello

Do (Inserts new prompts accordingly):
  ox\<CR>y\<esc>joz

Expect:
  vimshell: > echo Hello
  vimshell: > x
  vimshell: > y
  other: > echo Hello
  z

Execute (Change the prompt and new prompt is added accordingly):
  call vsh#vsh#SetPrompt('other: >')
  goto 1
  execute "normal! ox\<esc>joy\<CR>z"

Expect:
  vimshell: > echo Hello
  x
  other: > echo Hello
  other: > y
  other: > z


"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""
"                              vsh_clear_output                               "
"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""
Given vsh (vsh buffer):
  vimshell: > false
  vimshell: > echo Hello
  Hello
  vimshell: > echo Hello; echo there
  Hello
  there
  vimshell: > echo Hello; echo there
  Hello
  there

Execute (Remove non-existant output):
  python3 vsh_clear_output(1)

Expect:
  vimshell: > false
  vimshell: > echo Hello
  Hello
  vimshell: > echo Hello; echo there
  Hello
  there
  vimshell: > echo Hello; echo there
  Hello
  there

Execute (Remove single line output):
  python3 vsh_clear_output(2)

Expect:
  vimshell: > false
  vimshell: > echo Hello
  vimshell: > echo Hello; echo there
  Hello
  there
  vimshell: > echo Hello; echo there
  Hello
  there

Execute (Remove multi-line output):
  python3 vsh_clear_output(4)

Expect:
  vimshell: > false
  vimshell: > echo Hello
  Hello
  vimshell: > echo Hello; echo there
  vimshell: > echo Hello; echo there
  Hello
  there

Execute (Remove output at end of file):
  python3 vsh_clear_output(7)

Expect:
  vimshell: > false
  vimshell: > echo Hello
  Hello
  vimshell: > echo Hello; echo there
  Hello
  there
  vimshell: > echo Hello; echo there


"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""
"                               vsh_insert_text                               "
"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""

Given vsh (vsh buffer):
  vimshell: > echo 'Hello world' # test insert when no output already there
  vimshell: > echo 'Hello world'; echo 'there there' # test basic insert
  Hello world

  vimshell: > echo -n 'hello world'; echo ' this is a test' # joining lines
  hello world

Execute (First line of output when not initialised is skipped):
  1 mark p
  1 mark d
  python3 vsh_insert_text(['Hello world'], vim.current.buffer.number)

Expect:
  vimshell: > echo 'Hello world' # test insert when no output already there
  vimshell: > echo 'Hello world'; echo 'there there' # test basic insert
  Hello world

  vimshell: > echo -n 'hello world'; echo ' this is a test' # joining lines
  hello world

Execute (First insert of an output):
  1 mark p
  1 mark d
  let b:vsh_initialised = 1
  python3 vsh_insert_text(['Hello world'], vim.current.buffer.number)

Expect:
  vimshell: > echo 'Hello world' # test insert when no output already there
  Hello world
  vimshell: > echo 'Hello world'; echo 'there there' # test basic insert
  Hello world

  vimshell: > echo -n 'hello world'; echo ' this is a test' # joining lines
  hello world


Execute (Insert continuing an output):
  2 mark p
  4 mark d
  let b:vsh_initialised = 1
  python3 vsh_insert_text(['there there'], vim.current.buffer.number)

Expect:
  vimshell: > echo 'Hello world' # test insert when no output already there
  vimshell: > echo 'Hello world'; echo 'there there' # test basic insert
  Hello world
  there there
  vimshell: > echo -n 'hello world'; echo ' this is a test' # joining lines
  hello world

Execute (Insert at end of file):
  5 mark p
  $ mark d
  let b:vsh_initialised = 1
  python3 vsh_insert_text([' this is a test'], vim.current.buffer.number)

Expect:
  vimshell: > echo 'Hello world' # test insert when no output already there
  vimshell: > echo 'Hello world'; echo 'there there' # test basic insert
  Hello world

  vimshell: > echo -n 'hello world'; echo ' this is a test' # joining lines
  hello world this is a test

Execute (Multiline output):
  6 mark p
  $ mark d
  let b:vsh_initialised = 1
  python3 vsh_insert_text(['', 'Hello world', 'this is a test'], vim.current.buffer.number)

Expect:
  vimshell: > echo 'Hello world' # test insert when no output already there
  vimshell: > echo 'Hello world'; echo 'there there' # test basic insert
  Hello world

  vimshell: > echo -n 'hello world'; echo ' this is a test' # joining lines
  hello world
  Hello world
  this is a test


" Null bytes are encoded as newlines in the data given
Execute (Output with embedded NULL bytes):
  1 mark p
  1 mark d
  let b:vsh_initialised = 1
  python3 vsh_insert_text(['Hello\nworld', 'this is a test'], vim.current.buffer.number)

Expect:
  vimshell: > echo 'Hello world' # test insert when no output already there
  Hello world
  this is a test
  vimshell: > echo 'Hello world'; echo 'there there' # test basic insert
  Hello world

  vimshell: > echo -n 'hello world'; echo ' this is a test' # joining lines
  hello world


Execute (Insert when insert mark has been lost):
  2 mark p
  let b:vsh_initialised = 1
  python3 vsh_insert_text(['there there'], vim.current.buffer.number)

Expect:
  vimshell: > echo 'Hello world' # test insert when no output already there
  vimshell: > echo 'Hello world'; echo 'there there' # test basic insert
  Hello world

  there there
  vimshell: > echo -n 'hello world'; echo ' this is a test' # joining lines
  hello world


Execute (Insert at end of buffer when no marks are around):
  let b:vsh_initialised = 1
  python3 vsh_insert_text(['', 'Hello world'], vim.current.buffer.number)

Expect:
  vimshell: > echo 'Hello world' # test insert when no output already there
  vimshell: > echo 'Hello world'; echo 'there there' # test basic insert
  Hello world

  vimshell: > echo -n 'hello world'; echo ' this is a test' # joining lines
  hello world
  Hello world


" I don't know why, but if this test isn't last then I get errors in Vader.
" TODO Figure out why -- is it the sleep command?
"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""
"                             Runs basic commands                             "
"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""
Given vsh (vsh buffer):
  vimshell: > echo Hello

Execute (Run this command):
  Vrerun
  " Sleep for a little while to give the pty time to respond
  " Remove the prompt printed by the pty if in nvim
  if has('nvim')
    sleep 1
    normal! Gdd
  endif

Expect:
  vimshell: > echo Hello
  Hello

